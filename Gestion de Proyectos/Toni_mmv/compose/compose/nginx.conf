# Define los grupos de servidores backend (tus microservicios)
upstream ms_rag_service {
    # 'host.docker.internal' es un DNS especial dentro de Docker
    # que apunta al 'localhost' de tu MÁQUINA (el host).
    server ms-rag:80;
}

upstream ms_ask_service {
    server ms-ask:80;
}

upstream ms_evaluacion_service {
    server ms-evaluacion:80;
}


# Configuración del servidor principal (API Gateway)
server {
    # Nginx escuchará en el puerto 80 DENTRO del contenedor
    listen 80;
    server_name localhost;

    # --- INICIO DE CONFIGURACIÓN CORS ---
    # Esta configuración se aplica globalmente a todas las rutas.

    # Origen permitido. '*' es cualquiera.
    # Para producción, cámbialo a tu dominio frontend: ej. 'https://mi-frontend.com'
    add_header 'Access-Control-Allow-Origin' '*' always;

    # Métodos HTTP permitidos
    add_header 'Access-Control-Allow-Methods' 'GET, POST, PUT, DELETE, OPTIONS' always;

    # Encabezados personalizados permitidos (ej. 'Authorization' para tokens JWT)
    add_header 'Access-Control-Allow-Headers' 'Authorization, Content-Type, X-API-KEY' always;

    # Permitir que el navegador envíe credenciales (como cookies)
    add_header 'Access-Control-Allow-Credentials' 'true' always;

    # Tiempo que el navegador puede cachear esta configuración 'preflight'
    add_header 'Access-Control-Max-Age' 86400;

    # Manejo de solicitudes 'preflight' (método OPTIONS)
    # Nginx responde 204 (No Content) directamente sin pasar al backend.
    if ($request_method = 'OPTIONS') {
        return 204;
    }
    # --- FIN DE CONFIGURACIÓN CORS ---


    # --- INICIO DE ENRUTAMIENTO (PROXY) ---

    # Ruta para el servicio RAG
    # http://localhost:8080/rag/...
    location /ms-rag/ {

        client_max_body_size 200M;
        proxy_request_buffering off;
        # Reescribe la URL: /rag/mi/ruta -> /mi/ruta
        rewrite ^/ms-rag/(.*)$ /$1 break;
        
        # Pasa la solicitud al backend 'ms_rag_service'
        proxy_pass http://ms_rag_service;

        # Encabezados estándar para pasar al backend
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Ruta para el servicio ASK
    # http://localhost:8080/ask/...
    location /ms-ask/ {
        # Reescribe la URL: /ask/otra/ruta -> /otra/ruta
        rewrite ^/ms-ask/(.*)$ /$1 break;
        
        proxy_pass http://ms_ask_service;

        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    location /ms-evaluacion/ {

        client_max_body_size 200M;
        proxy_request_buffering off;
        # Reescribe la URL: /rag/mi/ruta -> /mi/ruta
        rewrite ^/ms-evaluacion/(.*)$ /$1 break;
        
        # Pasa la solicitud al backend 'ms_evaluacion_service'
        proxy_pass http://ms_evaluacion_service;

        # Encabezados estándar para pasar al backend
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # (Opcional) Una ruta para verificar que el gateway funciona
    location = /_gateway_status {
        return 200 "API Gateway: OK";
        add_header Content-Type text/plain;
    }
}